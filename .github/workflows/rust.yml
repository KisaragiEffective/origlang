name: Rust

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always
  CI_RUST_CACHE_VERSION: v1

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        rustc_channel: [stable, nightly]
        include:
          - rustc_channel: stable
            # renovate: rustc-stable
            rustc_version: '1.72.1'
          - rustc_channel: nightly
            # renovate: rustc-nightly
            rustc_version: '2023-09-30'

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4
    - name: Install compiler ${{ matrix.rustc_channel }} ( ${{ matrix.rustc_version }} )
      run: |
        if [[ "${{ matrix.rustc_channel }}" == nightly ]]; then
          rustup install nightly-${{ matrix.rustc_version }}
          rustup component add clippy --toolchain nightly-${{ matrix.rustc_version }}
          rustup override set nightly-${{ matrix.rustc_version }}
        else
          rustup install ${{ matrix.rustc_version }}
          rustup component add clippy --toolchain ${{ matrix.rustc_version }}
          rustup override set ${{ matrix.rustc_version }}
        fi
        
        rustup show
      shell: bash
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2.7.0
      with:
        prefix-key: ${{ matrix.os }}-${{ matrix.rustc_version }}-${{ env.CI_RUST_CACHE_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
    # See rust-wasm.yml for CI details about those package
    - name: Build package
      run: cargo build --workspace --exclude origlang-interop --exclude origlang-interop-frontend-webserver --verbose
    - name: Lint with clippy
      run: cargo clippy --exclude origlang-interop --exclude origlang-interop-frontend-webserver --verbose
    - name: Run tests
      run: cargo test --workspace --exclude origlang-interop --exclude origlang-interop-frontend-webserver --verbose
    - name: Run compile test
      run: cargo run -p origlang-testsuite
      env:
        RUST_BACKTRACE: 1
